<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>falch.me - Galaxian</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
            height: 100%;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <canvas id="scene"></canvas>
    <script>
        const canvas = document.getElementById('scene');
        const ctx = canvas.getContext('2d');
        let w, h;

        const spriteSheet = new Image();
        spriteSheet.src = 'sprites.png';

        const player = {
            x: 100,
            y: 0,
            width: 64,
            height: 64,
            speed: 4
        };

        const playerSprite = { x: 1, y: 70, w: 16, h: 16 };
        const keys = {};
        const bullets = [];

        let particles = [];
        const numParticles = 250;

        function generateParticles() {
            particles = [];
            for (let i = 0; i < numParticles; i++) {
                const rand = Math.random();
                particles.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: rand < 0.7 ? Math.random() * 0.6 + 0.3 : Math.random() * 2 + 1,
                    dx: (Math.random() - 0.5) * 0.4,
                    dy: (Math.random() - 0.5) * 0.4
                });
            }
        }

        const enemySprites = {
            red: {
                idle: [
                    { x: 1, y: 1, w: 16, h: 16 },
                    { x: 18, y: 1, w: 16, h: 16 },
                    { x: 35, y: 1, w: 16, h: 16 },
                    { x: 52, y: 1, w: 16, h: 16 }
                ],
                explode: [
                    { x: 60, y: 70, w: 16, h: 16 },
                    { x: 77, y: 70, w: 16, h: 16 },
                    { x: 94, y: 70, w: 16, h: 16 },
                    { x: 111, y: 70, w: 16, h: 16 }
                ]
            },

            blue: {
                idle: [
                    { x: 1, y: 35, w: 16, h: 16 },
                    { x: 18, y: 35, w: 16, h: 16 },
                    { x: 35, y: 35, w: 16, h: 16 },
                    { x: 52, y: 35, w: 16, h: 16 }
                ],
                explode: [
                    { x: 60, y: 70, w: 16, h: 16 },
                    { x: 77, y: 70, w: 16, h: 16 },
                    { x: 94, y: 70, w: 16, h: 16 },
                    { x: 111, y: 70, w: 16, h: 16 }
                ]
            },

            purple: {
                idle: [
                    { x: 1, y: 18, w: 16, h: 16 },
                    { x: 18, y: 18, w: 16, h: 16 },
                    { x: 35, y: 18, w: 16, h: 16 },
                    { x: 52, y: 18, w: 16, h: 16 }
                ],
                explode: [
                    { x: 60, y: 70, w: 16, h: 16 },
                    { x: 77, y: 70, w: 16, h: 16 },
                    { x: 94, y: 70, w: 16, h: 16 },
                    { x: 111, y: 70, w: 16, h: 16 }
                ]
            }
        };

        const enemyGrid = [];
        const spacing = 64;
        const enemySize = 64;

        let tick = 0;
        let enemyOffsetX = 0;
        let enemyDir = 1;

        function generateEnemies() {
            enemyGrid.length = 0;
            const totalWidth = 10 * spacing;
            const startX = (w - totalWidth) / 2;

            // Rad 0: 6 røde (kolonner 2–7)
            for (let col = 2; col < 8; col++) {
                enemyGrid.push({
                    type: 'red',
                    x: startX + col * spacing,
                    y: 100 + 0 * spacing
                });
            }

            // Rad 1: 8 lilla (kolonner 1–8)
            for (let col = 1; col < 9; col++) {
                enemyGrid.push({
                    type: 'purple',
                    x: startX + col * spacing,
                    y: 100 + 1 * spacing
                });
            }

            // Rader 2–4: 10 blå (kolonner 0–9)
            for (let row = 2; row < 5; row++) {
                for (let col = 0; col < 10; col++) {
                    enemyGrid.push({
                        type: 'blue',
                        x: startX + col * spacing,
                        y: 100 + row * spacing
                    });
                }
            }
        }

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            player.y = h - player.height - 10;
            generateParticles();
            generateEnemies();
        }

        window.addEventListener('resize', resize);
        resize();

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => {
            keys[e.code] = false;
            if (e.code === 'Space') {
                const bulletX = player.x + player.width / 2 - 2;
                const bulletY = player.y - 10;
                bullets.push({ x: bulletX, y: bulletY, speed: 5 });
            }
        });

        function updateEnemies() {
            enemyOffsetX += enemyDir;
            if (enemyOffsetX > 40 || enemyOffsetX < -40) {
                enemyDir *= -1;
            }
        }

        function drawEnemies() {
            const frame = Math.floor(tick / 10) % 4;
            for (let e of enemyGrid) {
                const sprite = enemySprites[e.type].idle[frame];
                ctx.drawImage(
                    spriteSheet,
                    sprite.x, sprite.y, sprite.w, sprite.h,
                    e.x + enemyOffsetX, e.y, enemySize, enemySize
                );
            }
        }

        function drawParticles() {
            for (let p of particles) {
                p.x += p.dx;
                p.y += p.dy;
                if (p.x < 0 || p.x > w) p.dx *= -1;
                if (p.y < 0 || p.y > h) p.dy *= -1;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
            }
        }

        function drawPlayer() {
            ctx.drawImage(
                spriteSheet,
                playerSprite.x, playerSprite.y, playerSprite.w, playerSprite.h,
                player.x, player.y, player.width, player.height
            );
        }

        function drawBullets() {
            ctx.fillStyle = 'white';
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= bullets[i].speed;
                if (bullets[i].y < 0) {
                    bullets.splice(i, 1);
                } else {
                    ctx.fillRect(bullets[i].x, bullets[i].y, 4, 20);
                }
            }
        }

        function updatePlayer() {
            if (keys['ArrowLeft']) player.x -= player.speed;
            if (keys['ArrowRight']) player.x += player.speed;
            player.x = Math.max(0, Math.min(player.x, w - player.width));
        }

        function animate() {
            ctx.clearRect(0, 0, w, h);
            tick++;

            drawParticles();
            updatePlayer();
            updateEnemies();
            drawPlayer();
            drawEnemies();   // fiender først
            drawBullets();   // skudd etterpå (over)

            requestAnimationFrame(animate);
        }

        spriteSheet.onload = animate;
    </script>
</body>

</html>